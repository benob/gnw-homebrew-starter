//#include <SDL2/SDL.h>
//#include <stdio.h>

#include <stdio.h>
#include <string.h>
#include <assert.h>

#include "main.h"
#include "gw_buttons.h"
#include "gw_lcd.h"
#include "gw_linker.h"
#include "bq24072.h"

#define CHAR_WIDTH 6
#define CHAR_HEIGHT 8
#define FONT "\x3f\x3f\x3f\x3f\x3f\x3f\x3f\x3f\x00\x0e\x15\x1f\x11\x1b\x0e\x00\x00\x0e\x15\x1f\x13\x15\x0e\x00\x00\x0a\x1f\x1f\x1f\x0e\x04\x00\x00\x04\x0e\x1f\x1f\x0e\x04\x00\x00\x0e\x0e\x15\x1f\x04\x0e\x00\x00\x04\x0e\x1f\x1f\x04\x0e\x00\x00\x00\x0c\x1e\x1e\x0c\x00\x00\x00\x00\x0c\x12\x12\x0c\x00\x00\x00\x00\x00\x0c\x0c\x00\x00\x00\x00\x00\x1f\x11\x11\x11\x1f\x00\x00\x00\x1f\x11\x15\x11\x1f\x00\x00\x00\x0f\x11\x0b\x15\x1b\x00\x0c\x14\x14\x04\x06\x07\x03\x00\x18\x16\x1a\x16\x12\x1a\x1b\x03\x00\x1f\x00\x1f\x00\x1f\x00\x00\x00\x01\x07\x1f\x3f\x1f\x07\x01\x00\x20\x38\x3e\x3f\x3e\x38\x20\x00\x1f\x11\x1b\x15\x11\x1f\x00\x00\x00\x1e\x13\x13\x1f\x0f\x00\x1e\x33\x2d\x2d\x21\x2d\x3f\x1e\x1e\x31\x2d\x31\x2d\x31\x3f\x1e\x1e\x2d\x2d\x33\x2d\x2d\x3f\x1e\x1e\x2d\x2d\x21\x2f\x31\x3f\x1e\x00\x04\x0e\x1f\x04\x04\x04\x00\x00\x04\x04\x04\x1f\x0e\x04\x00\x00\x00\x04\x0c\x1f\x0c\x04\x00\x00\x00\x04\x06\x1f\x06\x04\x00\x00\x00\x0e\x11\x11\x11\x0e\x00\x00\x00\x0e\x11\x15\x11\x0e\x00\x1f\x1f\x1f\x0e\x0e\x0e\x04\x04\x04\x04\x0e\x0e\x0e\x1f\x1f\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x04\x04\x04\x04\x04\x00\x04\x00\x12\x12\x12\x00\x00\x00\x00\x00\x0a\x0a\x1f\x0a\x1f\x0a\x0a\x00\x04\x1e\x05\x0e\x14\x0f\x04\x00\x10\x09\x08\x04\x02\x02\x11\x00\x06\x09\x01\x02\x15\x09\x16\x00\x0c\x08\x04\x00\x00\x00\x00\x00\x0c\x02\x02\x02\x02\x02\x0c\x00\x06\x08\x08\x08\x08\x08\x06\x00\x15\x0e\x1f\x0e\x15\x00\x00\x00\x00\x04\x04\x1f\x04\x04\x00\x00\x00\x00\x00\x00\x00\x0c\x08\x04\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x10\x08\x08\x04\x02\x02\x01\x00\x0e\x11\x11\x15\x11\x11\x0e\x00\x06\x04\x04\x04\x04\x04\x1f\x00\x0e\x11\x10\x08\x04\x02\x1f\x00\x1f\x10\x08\x0c\x10\x11\x0e\x00\x10\x08\x04\x12\x11\x1f\x10\x00\x1f\x01\x0f\x10\x10\x11\x0e\x00\x0e\x01\x0f\x11\x11\x11\x0e\x00\x1f\x11\x10\x08\x08\x04\x04\x00\x0e\x11\x11\x0e\x11\x11\x0e\x00\x0e\x11\x11\x11\x1e\x10\x0e\x00\x00\x00\x04\x00\x00\x04\x00\x00\x00\x00\x04\x00\x00\x06\x04\x02\x10\x08\x04\x02\x04\x08\x10\x00\x00\x00\x1f\x00\x00\x1f\x00\x00\x02\x04\x08\x10\x08\x04\x02\x00\x0e\x11\x10\x08\x04\x00\x04\x00\x0e\x11\x1d\x1d\x01\x01\x0e\x00\x04\x0a\x11\x11\x1f\x11\x11\x00\x0f\x11\x11\x0f\x11\x11\x0f\x00\x0e\x11\x01\x01\x01\x11\x0e\x00\x0f\x11\x11\x11\x11\x11\x0f\x00\x1f\x01\x01\x0f\x01\x01\x1f\x00\x1f\x01\x01\x0f\x01\x01\x01\x00\x0e\x11\x01\x1d\x11\x11\x0e\x00\x11\x11\x11\x1f\x11\x11\x11\x00\x1f\x04\x04\x04\x04\x04\x1f\x00\x1c\x10\x10\x10\x11\x11\x0e\x00\x11\x11\x09\x07\x09\x11\x11\x00\x01\x01\x01\x01\x01\x01\x1f\x00\x11\x1b\x15\x11\x11\x11\x11\x00\x11\x13\x13\x15\x19\x19\x11\x00\x0e\x11\x11\x11\x11\x11\x0e\x00\x0f\x11\x11\x0f\x01\x01\x01\x00\x0e\x11\x11\x11\x11\x09\x16\x00\x0f\x11\x11\x0f\x11\x11\x11\x00\x0e\x11\x01\x0e\x10\x11\x0e\x00\x1f\x04\x04\x04\x04\x04\x04\x00\x11\x11\x11\x11\x11\x11\x0e\x00\x11\x11\x11\x0a\x0a\x04\x04\x00\x15\x15\x15\x15\x15\x15\x0a\x00\x11\x11\x0a\x04\x0a\x11\x11\x00\x11\x11\x11\x0a\x04\x04\x04\x00\x1f\x10\x08\x04\x02\x01\x1f\x00\x07\x01\x01\x01\x01\x01\x07\x00\x01\x02\x02\x04\x08\x08\x10\x00\x07\x04\x04\x04\x04\x04\x07\x00\x04\x0a\x11\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x0c\x04\x08\x00\x00\x00\x00\x00\x00\x00\x0e\x10\x1e\x19\x16\x00\x01\x01\x0d\x13\x11\x13\x0d\x00\x00\x00\x0e\x11\x01\x11\x0e\x00\x10\x10\x16\x19\x11\x19\x16\x00\x00\x00\x0e\x11\x1f\x01\x0e\x00\x1c\x02\x1f\x02\x02\x02\x02\x00\x00\x00\x16\x19\x11\x1e\x10\x0e\x01\x01\x0d\x13\x11\x11\x11\x00\x04\x00\x06\x04\x04\x04\x1f\x00\x10\x00\x1c\x10\x10\x10\x11\x0e\x01\x01\x19\x07\x09\x11\x11\x00\x07\x04\x04\x04\x04\x04\x18\x00\x00\x00\x0b\x15\x15\x15\x11\x00\x00\x00\x0d\x13\x11\x11\x11\x00\x00\x00\x0e\x11\x11\x11\x0e\x00\x00\x00\x0d\x13\x11\x13\x0d\x01\x00\x00\x16\x19\x11\x19\x16\x10\x00\x00\x0d\x13\x01\x01\x01\x00\x00\x00\x1e\x01\x0e\x10\x0f\x00\x00\x02\x1f\x02\x02\x02\x1c\x00\x00\x00\x11\x11\x11\x11\x0e\x00\x00\x00\x11\x11\x0a\x0a\x04\x00\x00\x00\x15\x15\x15\x15\x0a\x00\x00\x00\x11\x0a\x04\x0a\x11\x00\x00\x00\x11\x11\x11\x1e\x10\x0e\x00\x00\x1f\x08\x04\x02\x1f\x00\x0e\x02\x02\x01\x02\x02\x0e\x00\x04\x04\x04\x00\x04\x04\x04\x00\x07\x04\x04\x08\x04\x04\x07\x00\x00\x0a\x05\x00\x00\x00\x00\x00\x21\x22\x12\x14\x0c\x0a\x12\x21\x10\x00\x02\x00\x10\x00\x02\x00\x2a\x00\x15\x00\x2a\x00\x15\x00\x2a\x15\x2a\x15\x2a\x15\x2a\x15\x15\x15\x15\x15\x00\x00\x00\x00\x00\x20\x10\x08\x04\x02\x01\x00\x00\x01\x02\x04\x08\x10\x20\x00\x04\x04\x04\x04\x04\x04\x04\x04\x00\x00\x00\x3f\x04\x04\x04\x04\x04\x04\x04\x07\x04\x04\x04\x04\x00\x00\x00\x3c\x04\x04\x04\x04\x00\x00\x00\x07\x04\x04\x04\x04\x00\x00\x00\x30\x08\x04\x04\x04\x00\x00\x00\x01\x02\x04\x04\x04\x04\x04\x04\x3f\x04\x04\x04\x04\x30\x38\x3c\x3e\x3e\x3f\x3f\x3f\x03\x07\x0f\x1f\x1f\x3f\x3f\x3f\x00\x00\x00\x00\x2a\x15\x2a\x15\x02\x05\x02\x05\x02\x05\x02\x05\x00\x14\x0a\x14\x0a\x14\x0a\x00\x15\x15\x15\x15\x15\x15\x15\x15\x00\x20\x30\x38\x3c\x3e\x3f\x3f\x00\x01\x03\x07\x0f\x1f\x3f\x3f\x00\x00\x00\x3f\x00\x00\x00\x00\x04\x04\x04\x3c\x04\x04\x04\x04\x04\x04\x04\x3f\x00\x00\x00\x00\x04\x04\x04\x3c\x00\x00\x00\x00\x04\x04\x04\x07\x00\x00\x00\x00\x04\x04\x08\x30\x00\x00\x00\x00\x04\x04\x02\x01\x00\x00\x00\x00\x00\x04\x00\x04\x00\x04\x00\x04\x3f\x3f\x3f\x3e\x3e\x3c\x38\x30\x3f\x3f\x3f\x1f\x1f\x0f\x07\x03\x28\x10\x28\x10\x28\x10\x28\x10\x2a\x15\x2a\x15\x00\x00\x00\x00\x3f\x00\x3f\x00\x3f\x00\x3f\x00\x00\x00\x00\x00\x15\x15\x15\x15\x00\x00\x00\x00\x38\x38\x38\x38\x00\x00\x00\x00\x07\x07\x07\x07\x00\x00\x00\x00\x00\x00\x3f\x3f\x00\x00\x00\x00\x00\x3f\x3f\x3f\x00\x00\x00\x00\x3f\x3f\x3f\x3f\x00\x00\x00\x3f\x3f\x3f\x3f\x3f\x00\x00\x3f\x3f\x3f\x3f\x3f\x3f\x00\x00\x00\x38\x00\x00\x00\x00\x00\x00\x00\x00\x04\x04\x04\x04\x00\x00\x00\x15\x00\x00\x00\x00\x00\x00\x00\x00\x20\x30\x30\x38\x00\x00\x00\x00\x01\x03\x03\x07\x2a\x15\x2a\x15\x02\x05\x02\x05\x2a\x15\x2a\x15\x28\x10\x28\x10\x00\x00\x00\x00\x28\x10\x28\x10\x00\x00\x00\x00\x02\x05\x02\x05\x38\x38\x38\x38\x00\x00\x00\x00\x07\x07\x07\x07\x00\x00\x00\x00\x38\x38\x38\x38\x07\x07\x07\x07\x03\x03\x03\x03\x03\x03\x03\x03\x07\x07\x07\x07\x07\x07\x07\x07\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x00\x0e\x11\x1f\x15\x11\x1f\x00\x04\x04\x04\x04\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x00\x00\x04\x0e\x1f\x1b\x15\x0e\x0a\x38\x30\x30\x20\x00\x00\x00\x00\x07\x03\x03\x01\x00\x00\x00\x00\x02\x05\x02\x05\x2a\x15\x2a\x15\x28\x10\x28\x10\x2a\x15\x2a\x15\x28\x10\x28\x10\x00\x00\x00\x00\x02\x05\x02\x05\x00\x00\x00\x00\x00\x00\x18\x15\x0b\x06\x0d\x00\x00\x00\x07\x08\x14\x12\x11\x00\x00\x00\x1c\x12\x14\x0a\x01\x00\x00\x00\x00\x00\x04\x15\x17\x0e\x01\x03\x07\x0f\x1f\x04\x08\x00\x02\x02\x0e\x1f\x1f\x1e\x0c\x00\x00\x1f\x1f\x0e\x0a\x11\x1f\x00\x00\x1f\x11\x0a\x0e\x15\x1f\x00\x00\x1f\x11\x0a\x0e\x1f\x1f\x00\x00\x1f\x11\x11\x1f\x04\x04\x00\x04\x15\x0e\x15\x0e\x15\x04\x00\x11\x00\x04\x0a\x04\x00\x11\x00\x00\x00\x1f\x0e\x1f\x1f\x1f\x0e\x00\x00\x02\x04\x0e\x1f\x1f\x0e\x10\x28\x10\x28\x05\x02\x05\x02\x05\x02\x05\x02\x10\x28\x10\x28\x10\x10\x02\x02\x00\x00\x08\x08\x00\x01\x11\x10\x00\x04\x04\x00\x04\x0c\x0e\x1e\x1f\x1f\x04\x04\x00\x00\x0e\x1f\x1f\x1f\x1f\x0e\x00\x00\x00\x00\x00\x08\x1c\x1e\x00\x0c\x1e\x1f\x1f\x0e\x04\x04\x00\x00\x06\x1f\x1f\x1f\x0e\x04\x00\x0a\x17\x17\x17\x0e\x04\x00\x00\x0a\x15\x11\x11\x0a\x04\x00\x3f\x01\x01\x01\x01\x01\x01\x01\x3f\x00\x00\x00\x00\x00\x00\x00\x3f\x20\x20\x20\x20\x20\x20\x20\x00\x00\x16\x1d\x1f\x16\x00\x00\x00\x00\x0d\x17\x1f\x0d\x00\x00\x00\x0c\x17\x0c\x06\x1f\x1f\x0e\x00\x06\x1d\x06\x0c\x1f\x1f\x0e\x00\x00\x0e\x15\x1f\x0e\x00\x00\x00\x0e\x1f\x15\x1f\x0a\x00\x00\x00\x00\x00\x00\x08\x0e\x16\x1f\x00\x3d\x00\x37\x00\x3d\x00\x37\x04\x04\x1f\x0e\x0e\x1b\x11\x00\x00\x00\x04\x0e\x04\x0a\x00\x00\x00\x0e\x0e\x04\x0e\x15\x0a\x0a\x0e\x0e\x04\x1f\x04\x0a\x11\x00\x00\x0e\x0e\x15\x0e\x04\x0a\x0a\x01\x01\x01\x01\x01\x01\x01\x01\x3f\x21\x21\x21\x21\x21\x21\x3f\x20\x20\x20\x20\x20\x20\x20\x20\x00\x0c\x1e\x1f\x1f\x1f\x0e\x00\x00\x06\x0f\x1e\x1c\x1f\x0e\x00\x00\x0c\x1e\x0f\x07\x1f\x0e\x00\x00\x0e\x1f\x15\x1f\x1f\x15\x00\x00\x15\x1f\x15\x0e\x11\x00\x00\x15\x1f\x15\x1f\x0a\x00\x00\x00\x00\x0e\x15\x1f\x1b\x15\x0e\x00\x00\x0e\x15\x1f\x11\x11\x0e\x00\x00\x00\x0e\x1f\x15\x1f\x11\x1b\x00\x0e\x1f\x15\x1f\x0a\x0a\x1b\x00\x0c\x12\x21\x21\x21\x21\x21\x00\x0c\x1e\x3f\x2f\x3f\x3f\x3f\x00\x00\x02\x1d\x15\x02\x00\x00\x01\x01\x01\x01\x01\x01\x01\x3f\x00\x00\x00\x00\x00\x00\x00\x3f\x20\x20\x20\x20\x20\x20\x20\x3f"

#define WIDTH 320
#define HEIGHT 240

typedef unsigned char u8;
typedef signed char i8;
typedef unsigned short u16;
typedef signed short i16;
typedef unsigned int u32;
typedef signed int i32;
typedef u16 Color;

//u16 framebuffer[WIDTH * HEIGHT];
uint32_t random_state = 0x1a3bb483;

static uint32_t rnd() {
	/* Algorithm "xor" from p. 4 of Marsaglia, "Xorshift RNGs" */
	uint32_t x = random_state;
	x ^= x << 13;
	x ^= x >> 17;
	x ^= x << 5;
	return random_state = x;
}

#define abs(x) ((x) < 0 ? -(x) : (x))

static void clear_screen() {
  u16* framebuffer = lcd_get_active_buffer();
  memset(framebuffer, 0, WIDTH * HEIGHT * sizeof(u16));
}

static void clear_both_framebuffers() {
  memset(framebuffer1, 0, WIDTH * HEIGHT * sizeof(u16));
  memset(framebuffer2, 0, WIDTH * HEIGHT * sizeof(u16));
}

static void draw_point(i32 x, i32 y, Color color) {
  u16* framebuffer = lcd_get_active_buffer();
  if (x >= 0 && x < WIDTH && y >= 0 && y < HEIGHT) framebuffer[y * WIDTH + x] = color;
}

/*static void hline(i32 x1, i32 x2, i32 y, Color color) {
  while(x1 < x2) {
    draw_point(x1, y, color);
    ++x1;
  }
}

static void vline(i32 x, i32 y1, i32 y2, Color color) {
  while(y1 < y2) {
    draw_point(x, y1, color);
    ++y1;
  }
}*/

static void draw_rect(i32 x, i32 y, i32 width, i32 height, Color color) {
  if (x < 0) {
    width += x;
    x = 0;
  }
  if (y < 0) {
    height += y;
    y = 0;
  }
  if (x + width > WIDTH) width = WIDTH - x;
  if (y + height > HEIGHT) height = HEIGHT - y;

  u16* framebuffer = lcd_get_active_buffer();
  for (i32 j = y; j < y + height; ++j) {
    u16* pixel = &framebuffer[j * WIDTH + x];
    for (i32 i = 0; i < width; ++i) *(pixel++) = color;
  }
}

static void draw_line(i32 x0, i32 y0, i32 x1, i32 y1, Color color) {
  i32 dx =  abs(x1-x0);
  i32 sx = x0 < x1 ? 1 : -1;
  i32 dy = -abs(y1-y0);
  i32 sy = y0<y1 ? 1 : -1;
  i32 err = dx + dy;  /* error value e_xy */
  while (1) {   /* loop */
    draw_point(x0, y0, color);
    if (x0 == x1 && y0 == y1) break;
    i32 e2 = 2*err;
    if (e2 >= dy) { /* e_xy+e_x > 0 */
      err += dy;
      x0 += sx;
    }
    if (e2 <= dx) { /* e_xy+e_y < 0 */
      err += dx;
      y0 += sy;
    }
  }
}

static void draw_circle(i32 xm, i32 ym, i32 r, Color color) {
   i32 x = -r, y = 0, err = 2 - 2 * r; /* II. Quadrant */
   do {
      draw_point(xm - x, ym + y, color); /*   I. Quadrant */
      draw_point(xm - y, ym - x, color); /*  II. Quadrant */
      draw_point(xm + x, ym - y, color); /* III. Quadrant */
      draw_point(xm + y, ym + x, color); /*  IV. Quadrant */
      r = err;
      if (r <= y) err += ++y * 2 + 1;           /* e_xy+e_y < 0 */
      if (r > x || err > y) err += ++x * 2 + 1; /* e_xy+e_x > 0 or no 2nd y-step */
   } while (x < 0);
}

static void draw_char(i32 x, i32 y, u8 c, Color color) {
  for (i32 j = 0; j < CHAR_HEIGHT; j++) {
    u8 row = FONT[c * CHAR_HEIGHT + j];
    for (i32 i = 0; i < CHAR_WIDTH; i++) {
      u8 bit = row & (1 << i);
      if (bit != 0) draw_point(x + i, y + j, color);
    }
  }
}

static void draw_text(i32 x, i32 y, const char* text, Color color) {
  i32 i = x;
  while(*text) {
    if (*text == '\n') {
      i = x;
      y += CHAR_HEIGHT;
    } else {
      draw_char(i, y, *text, color);
      i += CHAR_WIDTH;
    }
    text++;
  }
}

int mode = 7;
int frame = 0;

static void update() {
  char buffer[1024];
  char* battery_state[4] = {"missing", "chargning", "discharging", "full"};
  snprintf(buffer, 1024, "frame=%d\nbuttons=%lx\nbat=%d%% %s", frame, buttons_get(), bq24072_get_percent_filtered(), battery_state[bq24072_get_state()]);
  frame++;

  u16* framebuffer = lcd_get_active_buffer();
  switch (mode) {
    case 0:
      for( int i = 0; i < WIDTH * HEIGHT; i++) framebuffer[i] = rnd() % 65536;
      break;

    case 1:
      for (int j = 0; j < 16; j++) {
        for (int i = 0; i < 16; i++) {
          draw_char(i * CHAR_WIDTH, j * CHAR_HEIGHT, i + j * 16, 0xffff);
        }
      }
      break;

    case 2:
      clear_screen();
      for (int i = 0; i < 100; i++)
        draw_text(rnd() % WIDTH - 50, rnd() % HEIGHT, "Hello world. This is some funny text!", rnd() % 65536);
      break;

    case 3:
      clear_screen();
      for (int j = 0; j < HEIGHT / CHAR_HEIGHT; j++) {
        for (int i = 0; i < WIDTH / CHAR_WIDTH; i++) {
          draw_char(i * CHAR_WIDTH, j * CHAR_HEIGHT, rnd() % 256, rnd() % 65536);
        }
      }
      break;

    case 4:
      for (int i = 0; i < 100; i++)
        draw_rect(rnd() % WIDTH, rnd() % HEIGHT, rnd() % 100 + 50, rnd() % 100 + 50, rnd() % 65535);
      break;

    case 5:
      for (int i = 0; i < 100; i++)
        draw_line(rnd() % WIDTH, rnd() % HEIGHT, rnd() % WIDTH, rnd() % HEIGHT, rnd() % 65536);
      break;

    case 6:
      for (int i = 0; i < 100; i++)
        draw_circle(rnd() % WIDTH, rnd() % HEIGHT, 20 + rnd() % 100, rnd() % 65536);
          break;

    case 7:
      clear_screen();
      draw_text(50, 50, buffer, 0x0f0f);
      break;
  }
}

uint32_t button_state = 0;

int button_released(uint32_t button) {
  uint32_t buttons = buttons_get();
  int result = 0;
  if(buttons & button) {
    button_state |= button;
  } else {
    if(button_state & button) {
      result = 1;
    }
    button_state &= ~button;
  }
  return result;
}

void app_main() {
  lcd_backlight_set(255);
  memset(framebuffer1, 0x0, sizeof(framebuffer1));
  memset(framebuffer2, 0x0, sizeof(framebuffer2));

  int running = 1;
  while (running) {
    wdog_refresh();
    if (button_released(B_PAUSE)) {
      running = 0;
      break;
    } 
    if (button_released(B_POWER)) {
      GW_EnterDeepSleep();
    }
    if (button_released(B_Right)) {
      clear_both_framebuffers();
      mode++; if(mode > 7) mode = 0;
    }
    if (button_released(B_Left)) {
      clear_both_framebuffers();
      mode--; if(mode < 0) mode = 7;
    }
    update();
    lcd_swap();
    HAL_Delay(20);
  }
}

/*int main(int argc, char** argv) {
  SDL_Window* window;
  SDL_Renderer* renderer;

  SDL_Init(SDL_INIT_VIDEO);
  SDL_CreateWindowAndRenderer(WIDTH * 2, HEIGHT * 2, SDL_WINDOW_RESIZABLE, &window, &renderer);

  SDL_Surface* surface = SDL_CreateRGBSurfaceWithFormatFrom(framebuffer, WIDTH, HEIGHT, 1, WIDTH, SDL_PIXELFORMAT_RGB565);

  while(1) {
  SDL_Event event;
  while (SDL_PollEvent(&event)) {
  if (event.type == SDL_QUIT)	exit(0);
  else if (event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_ESCAPE) exit(0);
  }
  SDL_LockSurface(surface);

  update();

  SDL_UnlockSurface(surface);

  SDL_Texture* texture = SDL_CreateTextureFromSurface(renderer, surface);
  SDL_RenderCopy(renderer, texture, NULL, NULL);
  SDL_RenderPresent(renderer);
  SDL_DestroyTexture(texture);

  SDL_Delay(16);
  }
  }*/
